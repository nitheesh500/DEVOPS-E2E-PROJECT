# CI Pipeline â€“ Jenkins Setup (Spring PetClinic)

This document describes the **Continuous Integration (CI)** setup implemented using **Jenkins** for the Spring PetClinic application.

The CI pipeline follows **industry best practices**:
- Pipeline as Code (Jenkinsfile)
- Secure credentials handling
- Code quality enforcement
- Container security scanning

---

---

## ğŸ›  Tools Used

| Tool | Purpose |
|----|----|
| Jenkins | CI orchestration |
| Maven | Build & unit testing |
| SonarQube | Static code analysis |
| Docker | Containerization |
| Trivy | Container vulnerability scanning |
| GitHub | Source control |

---

## ğŸ” Prerequisites

Ensure the following are installed and configured on the Jenkins server:

- Java 17 (Amazon Corretto)
- Maven
- Docker
- Git
- Trivy
- SonarQube (running on port `9000`)
- Jenkins running on port `8081`

---

## ğŸ”§ Jenkins Configuration (One-Time Setup)

### 1ï¸âƒ£ Required Jenkins Plugins

Install the following plugins from **Manage Jenkins â†’ Plugins**:

- Git
- Pipeline
- Docker Pipeline
- SonarQube Scanner
- Credentials Binding

---

### 2ï¸âƒ£ Global Tool Configuration

Navigate to **Manage Jenkins â†’ Tools**

#### Java
- Name: `jdk17`
- JAVA_HOME: `/usr/lib/jvm/java-17-amazon-corretto`

#### Maven
- Name: `maven3`
- MAVEN_HOME: `/usr/share/maven`

<!-- #### sonar
- Name: sonar-server
- Server URL: http://<sonarqube-ip>:9000
- Authentication Token: add via Jenkins credentials -->

---

### 3ï¸âƒ£ SonarQube Configuration

Navigate to **Manage Jenkins â†’ System**

- SonarQube Name: `sonar-server`
- SonarQube URL: `http://localhost:9000`

#### SonarQube Token
- Generate token from SonarQube UI
- Add to Jenkins credentials:
  - Kind: `Secret Text`
  - ID: `sonar-token`

#### âŒ Why Jenkins is stuck at PENDING

Because Jenkins does NOT know the Quality Gate result yet.  
That result is sent back to Jenkins via a webhook.    
ğŸ‘‰ You have NOT configured the SonarQube â†’ Jenkins webhook.

Without webhook:

- Jenkins keeps polling
- Status stays PENDING
- Pipeline appears stuck

In SonarQube UI:
```
Administration â†’ Configuration â†’ Webhooks â†’ Create
        or 
projectsetting -> webhooks
```

Fill:

- Name: ```jenkins```

- URL:
```http://<JENKINS_IP>:8080/sonarqube-webhook/```

âœ… Save

âš ï¸ Note the trailing slash is mandatory

---

### 4ï¸âƒ£ Docker Registry Credentials

Add Docker registry credentials in Jenkins:

- Kind: `Username/Password`
- ID: `dockerhub-creds`
- Username: DockerHub username
- Password: DockerHub password or access token

### 5 Github  Credentials
- Kind: `Username/Password`
- ID: `github-creds`
- Username: github username
- Password: PAT

---

## ğŸ“„ Pipeline Stages (High Level)

The Jenkins pipeline consists of the following stages:

```
Checkout
â†’ GitLeaks Scan
â†’ Compile
â†’ Dependency Check(via pom.xml)
â†’ Unit Tests
â†’ SonarQube Scan
â†’ Quality Gate
â†’ Package (JAR)
â†’ Docker Image Build
â†’ Trivy Image Scan
â†’ Docker Push
â†’ Update Manifest Repo

```
### Refer to [Jenkins Script](https://github.com/nitheesh500/spring-petclinic-mono/blob/40c5669f4000ce9d19496567cec99417ac7b58ab/Jenkinsfile)
---

## ğŸ§ª Test Strategy

- Unit tests run as part of the Maven build
- Integration tests are skipped in CI to avoid external dependencies
- Database-backed tests are executed only in controlled environments

---

## ğŸ” Code Quality

- SonarQube enforces quality gates
- Pipeline fails if quality gate conditions are not met
- Prevents low-quality code from progressing further

---

## ğŸ” Security Scanning

- Trivy scans Docker images for:
  - HIGH vulnerabilities
  - CRITICAL vulnerabilities
- Results are visible in Jenkins console logs

---

## ğŸ“¦ Artifact Output

- Docker image pushed to Docker registry
- Image tag follows Jenkins build number
- Image is later deployed via GitOps (Argo CD)

---

## ğŸ§  Best Practices Followed

- Pipeline as Code
- Least privilege access
- Non-root Docker containers
- Separation of CI and CD
- GitOps-based deployment

---

## ğŸš€ Next Step

After CI completion:
- Image tag is updated in the **Kubernetes manifest repository**
- Argo CD automatically deploys the new version to EKS

Refer to the [CD Setup Documentation](https://github.com/nitheesh500/DEVOPS-E2E-PROJECT/blob/c5e35fb4d2f9cf8b5448b96a69a6ecbb0b6e7d52/terraform/README-FILES/CD-SETUP.MD) for deployment details.

---
